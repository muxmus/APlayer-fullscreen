$("#barDone").click(function(e){
	ap.seek((ap.audio.currentTime * e.offsetX / this.offsetWidth).toFixed(6));
});
$("#barDo").click(function(e){
	ap.seek(((ap.audio.duration - ap.audio.currentTime) * e.offsetX / this.offsetWidth + ap.audio.currentTime).toFixed(6));
});
ap.on('timeupdate', () => {
	$('#barDone').attr('style','width: ' + ((ap.audio.currentTime / ap.audio.duration) * 100).toFixed(2) + '%');
	$('#barCircle').attr('style','left: calc(' + ((ap.audio.currentTime / ap.audio.duration) * 100).toFixed(2) + '% - 2px)');
	$('#barDo').attr('style','width: ' + ((1 - (ap.audio.currentTime / ap.audio.duration)) * 100).toFixed(2) + '%');
	document.getElementById("timeDone").innerHTML = timeString(Math.floor(ap.audio.currentTime));
	$('#aplayer-lrc-test').attr('style','width:' + $(".aplayer-lrc-current").width() + 'px');
});
ap.on("loadstart", () => {
	const currentPlayMeta = ap.list.audios[ap.list.index];
	document.getElementById("apName").innerHTML = '<span class="txt">' + currentPlayMeta.name + '</span><span class="title" data-title="' + currentPlayMeta.name + '">' + currentPlayMeta.name + '</span>';
	document.getElementById("apArtist").innerHTML = '<span class="txt">' + currentPlayMeta.artist + '</span><span class="title" data-title="' + currentPlayMeta.artist + '">' + currentPlayMeta.artist + '</span>';
	overflow();
	document.getElementById('metadata').innerHTML = currentPlayMeta.metadata[0].containerformat + ' | ' + currentPlayMeta.metadata[0].codec + ' | ' + Math.floor(currentPlayMeta.metadata[0].bitrate/1000) + 'kbps | ' + currentPlayMeta.metadata[0].samplingrate + 'Hz';
	if(currentPlayMeta.metadata[0].name != undefined){
		document.getElementById('metadata-name').innerHTML = '名称：' + currentPlayMeta.metadata[0].name;
	}else{
		document.getElementById('metadata-name').innerHTML = '名称：未知';
	};
	if(currentPlayMeta.metadata[0].artist != undefined){
		document.getElementById('metadata-artist').innerHTML = '作者：' + currentPlayMeta.metadata[0].artist;
	}else{
		document.getElementById('metadata-artist').innerHTML = '作者：未知';
	};
	if(currentPlayMeta.metadata[0].album != undefined){
		document.getElementById('metadata-album').innerHTML = '专辑：' + currentPlayMeta.metadata[0].album;
	}else{
		document.getElementById('metadata-album').innerHTML = '专辑：未知';
	};
	if(currentPlayMeta.metadata[0].filesize != undefined){
		document.getElementById('metadata-filesize').innerHTML = '大小：' + (currentPlayMeta.metadata[0].filesize/1000000).toFixed(2) + ' MB';
	}else{
		document.getElementById('metadata-filesize').innerHTML = '大小：未知';
	};
	if(currentPlayMeta.metadata[0].containerformat != undefined){
		document.getElementById('metadata-containerformat').innerHTML = '容器格式：' + currentPlayMeta.metadata[0].containerformat;
	}else{
		document.getElementById('metadata-containerformat').innerHTML = '容器格式：未知';
	};
	if(currentPlayMeta.metadata[0].codec != undefined){
		document.getElementById('metadata-codec').innerHTML = '编码格式：' + currentPlayMeta.metadata[0].codec;
	}else{
		document.getElementById('metadata-codec').innerHTML = '编码格式：未知';
	};
	if(currentPlayMeta.metadata[0].bitdepth != undefined){
		document.getElementById('metadata-bitdepth').innerHTML = '位深：' + currentPlayMeta.metadata[0].bitdepth + ' bit';
	}else{
		document.getElementById('metadata-bitdepth').innerHTML = '位深：未知';
	};
	if(currentPlayMeta.metadata[0].channel != undefined){
		document.getElementById('metadata-channel').innerHTML = '声道：' + currentPlayMeta.metadata[0].channel;
	}else{
		document.getElementById('metadata-channel').innerHTML = '声道：未知';
	};
	if(currentPlayMeta.metadata[0].duration != undefined){
		document.getElementById('metadata-duration').innerHTML = '时长：' + timeString(Math.floor(currentPlayMeta.metadata[0].duration));
	}else{
		document.getElementById('metadata-duration').innerHTML = '时长：未知';
	};
	if(currentPlayMeta.metadata[0].samplingrate != undefined){
		document.getElementById('metadata-samplingrate').innerHTML = '采样率：' + currentPlayMeta.metadata[0].samplingrate + ' Hz';
	}else{
		document.getElementById('metadata-samplingrate').innerHTML = '采样率：未知';
	};
	if(currentPlayMeta.metadata[0].bitrate != undefined){
		document.getElementById('metadata-bitrate').innerHTML = '比特率：' + Math.floor(currentPlayMeta.metadata[0].bitrate/1000) + ' kbps';
	}else{
		document.getElementById('metadata-bitrate').innerHTML = '比特率：未知';
	};
	navigator.mediaSession.metadata = new MediaMetadata({
		title: currentPlayMeta.name,
		artist: currentPlayMeta.artist,
		artwork: [{src: currentPlayMeta.cover}]
	});
	navigator.mediaSession.setActionHandler("previoustrack",function(){
		ap.skipBack();
	});
	navigator.mediaSession.setActionHandler("nexttrack",function(){
		ap.skipForward();
	});
	if(iconOrder){
		if(ap.list.audios[ap.list.player.randomOrder[ap.list.player.randomOrder.indexOf(ap.list.index) + 1]] != undefined){
			preload(ap.list.audios[ap.list.player.randomOrder[ap.list.player.randomOrder.indexOf(ap.list.index) + 1]].cover);
		}else{
			preload(ap.list.audios[ap.list.player.randomOrder[0]].cover);
		};
		if(ap.list.audios[ap.list.player.randomOrder[ap.list.player.randomOrder.indexOf(ap.list.index) - 1]] != undefined){
			preload(ap.list.audios[ap.list.player.randomOrder[ap.list.player.randomOrder.indexOf(ap.list.index) - 1]].cover);
		}else{
			preload(ap.list.audios[ap.list.player.randomOrder[ap.list.player.randomOrder.length - 1]].cover);
		};
	}else{
		if(ap.list.audios[ap.list.index + 1] != undefined){
			preload(ap.list.audios[ap.list.index + 1].cover);
		}else{
			preload(ap.list.audios[0].cover);
		};
		if(ap.list.audios[ap.list.index - 1] != undefined){
			preload(ap.list.audios[ap.list.index - 1].cover);
		}else{
			preload(ap.list.audios[ap.list.audios.length - 1].cover);
		};
	};
});
ap.on("loadedmetadata", () => {
	const currentPlayMeta = ap.list.audios[ap.list.index];
	if(apFlag){
		ap.play();
		$('#bgPic').attr('style','background: url("' + currentPlayMeta.cover + '") center center / cover no-repeat fixed black; transition: background .8s;');
		$('#apPic').attr('style','background: url("' + currentPlayMeta.cover + '") center / cover no-repeat black; transition: background .8s;');
	}else{
		$('#bgPic').attr('style','background: url("' + currentPlayMeta.cover + '") center center / cover no-repeat fixed black;');
		$('#apPic').attr('style','background: url("' + currentPlayMeta.cover + '") center / cover no-repeat black;');
	};
	apFlag = true;
	document.getElementById("timeTotal").innerHTML = timeString(Math.floor(ap.audio.duration));
	$('.aplayer-lrc-contents p').each(function(){
		if(!$(this).html().includes('<br>(') && !$(this).html().includes(' - ') && !$(this).html().includes('：')){
			$(this).html($(this).html().replace(/(.*) \(/, '$1<br>('));
		};
	});
	$('#aplayer-lrc-test').attr('style','width:' + $(".aplayer-lrc-current").width() + 'px');
	$('#aplayer-lrc-test').html($('.aplayer-lrc-current').html());
});
ap.on('play',function(){
	document.getElementById("icon-play").innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 17 32"><path d="M14.080 4.8q2.88 0 2.88 2.048v18.24q0 2.112-2.88 2.112t-2.88-2.112v-18.24q0-2.048 2.88-2.048zM2.88 4.8q2.88 0 2.88 2.048v18.24q0 2.112-2.88 2.112t-2.88-2.112v-18.24q0-2.048 2.88-2.048z"></path></svg>';
});
ap.on('pause',function(){
	document.getElementById("icon-play").innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 16 31"><path d="M15.552 15.168q0.448 0.32 0.448 0.832 0 0.448-0.448 0.768l-13.696 8.512q-0.768 0.512-1.312 0.192t-0.544-1.28v-16.448q0-0.96 0.544-1.28t1.312 0.192z"></path></svg>';
});
$("#aplayer").attr("class","aplayer aplayer-withlist aplayer-fixed");
$("#icon-play").click(function(){
	if(ap.audio.paused){
		ap.play();
	}else{
		ap.pause();
	};
});
$("#icon-back").click(function(){
	ap.skipBack()
	ap.play();
});
$("#icon-forward").click(function(){
	ap.skipForward();
	ap.play();
});
$("#icon-lrc").click(function(){
	ap.lrc.toggle();
});
$("#icon-volume-down").click(function(){
	if(volumeNow > 0.1){
		volumeNow = (volumeNow*10 - 1) / 10;
	}else if(volumeNow == 0.1){
		volumeNow = 0;
		volumeLast = 0.1;
	};
	ap.volume(volumeNow, true);
});
$("#icon-volume-up").click(function(){
	if(volumeNow < 1){
		volumeNow = (volumeNow*10 + 1) / 10;
	};
	ap.volume(volumeNow, true);
});
ap.on('volumechange', () => {
	$('#volumeBarDone').attr('style','width:' + volumeNow*100 + '%');
	$('#volumeBarDo').attr('style','width:' + (100 - volumeNow*100) + '%');
});
$(document).keyup(function(event){
	if(event.keyCode == 32){
		$('#icon-play').trigger('click');
	}else if(event.keyCode == 37){
		$('#icon-back').trigger('click');
	}else if(event.keyCode == 39){
		$('#icon-forward').trigger('click');
	}else if(event.keyCode == 76){
		$('#icon-lrc').trigger('click');
	}else if(event.keyCode == 77){
		if(volumeNow != 0){
			volumeLast = volumeNow;
			volumeNow = 0;
		}else{
			volumeNow = volumeLast;
		};
		ap.volume(volumeNow, true);
	}else if(event.keyCode == 80){
		$('#icon-list').trigger('click');
	};
});
$(document).keydown(function(event){
	if(event.keyCode == 38){
		$('#icon-volume-up').trigger('click');
	}else if(event.keyCode == 40){
		$('#icon-volume-down').trigger('click');
	};
});
$("#icon-list").click(function(){
	ap.list.toggle();
	if(listFlag){
		$("#icon-list svg").attr("style","");
		listFlag = false;
	}else{
		$("#icon-list svg").attr("style","background-color: #8e8cd8; opacity: 1;");
		listFlag = true;
	};
});
$("#icon-order").click(function(){
	$('.aplayer-icon-order').trigger('click');
	if(iconOrder){
		document.getElementById("icon-order").innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 32 32"><path d="M0.622 18.334h19.54v7.55l11.052-9.412-11.052-9.413v7.549h-19.54v3.725z"></path></svg>';
		if(ap.list.audios[ap.list.index + 1] != undefined){
			preload(ap.list.audios[ap.list.index + 1].cover);
		}else{
			preload(ap.list.audios[0].cover);
		};
		if(ap.list.audios[ap.list.index - 1] != undefined){
			preload(ap.list.audios[ap.list.index - 1].cover);
		}else{
			preload(ap.list.audios[ap.list.audios.length - 1].cover);
		};
		iconOrder = false;
	}else{
		document.getElementById("icon-order").innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 32 32"><path d="M22.667 4l7 6-7 6 7 6-7 6v-4h-3.653l-3.76-3.76 2.827-2.827 2.587 2.587h2v-8h-2l-12 12h-6v-4h4.347l12-12h3.653v-4zM2.667 8h6l3.76 3.76-2.827 2.827-2.587-2.587h-4.347v-4z"></path></svg>';
		if(ap.list.audios[ap.list.player.randomOrder[ap.list.player.randomOrder.indexOf(ap.list.index) + 1]] != undefined){
			preload(ap.list.audios[ap.list.player.randomOrder[ap.list.player.randomOrder.indexOf(ap.list.index) + 1]].cover);
		}else{
			preload(ap.list.audios[ap.list.player.randomOrder[0]].cover);
		};
		if(ap.list.audios[ap.list.player.randomOrder[ap.list.player.randomOrder.indexOf(ap.list.index) - 1]] != undefined){
			preload(ap.list.audios[ap.list.player.randomOrder[ap.list.player.randomOrder.indexOf(ap.list.index) - 1]].cover);
		}else{
			preload(ap.list.audios[ap.list.player.randomOrder[ap.list.player.randomOrder.length - 1]].cover);
		};
		iconOrder = true;
	};
});
$("#icon-loop").click(function(){
	$('.aplayer-icon-loop').trigger('click');
	if(iconLoop == 0){
		document.getElementById("icon-loop").innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 33 32"><path d="M9.333 9.333h13.333v4l5.333-5.333-5.333-5.333v4h-16v8h2.667v-5.333zM22.667 22.667h-13.333v-4l-5.333 5.333 5.333 5.333v-4h16v-8h-2.667v5.333zM17.333 20v-8h-1.333l-2.667 1.333v1.333h2v5.333h2z"></path></svg>';
		iconLoop = 1;
	}else if(iconLoop == 1){
		document.getElementById("icon-loop").innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 29 32"><path d="M2.667 7.027l1.707-1.693 22.293 22.293-1.693 1.707-4-4h-11.64v4l-5.333-5.333 5.333-5.333v4h8.973l-8.973-8.973v0.973h-2.667v-3.64l-4-4zM22.667 17.333h2.667v5.573l-2.667-2.667v-2.907zM22.667 6.667v-4l5.333 5.333-5.333 5.333v-4h-10.907l-2.667-2.667h13.573z"></path></svg>';
		iconLoop = 2;
	}else{
		document.getElementById("icon-loop").innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 29 32"><path d="M9.333 9.333h13.333v4l5.333-5.333-5.333-5.333v4h-16v8h2.667v-5.333zM22.667 22.667h-13.333v-4l-5.333 5.333 5.333 5.333v-4h16v-8h-2.667v5.333z"></path></svg>';
		iconLoop = 0;
	};
});
$(document).ready(function(){
	$(window).resize(function(){
		overflow();
	});
});